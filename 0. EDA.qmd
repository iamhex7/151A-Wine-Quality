---
title: EDA
format: typst
fig-width: 10
fig-height: 8
execute:
  warning: false
  message: false
---


## Goal
- Examine distributions of variables, identify skewness, and determine whether transformation is needed.
- Examine correlation structure to identify potential multicollinearity.
- Compare distributions of chemical attributes between red and white wines to identify potential interactions.
- Use scatterplots to assess the direction and strength of linear relationships.

```{r}
# prep
library(tidyverse)
library(ggplot2)
library(tidyr)
library(corrplot)

wine <- read_csv("data/wine.csv")
wine <- wine |>
  mutate(
    type = factor(
      type,
      levels = c(0, 1),
      labels = c("red", "white")
    )
  )
```


## Histogram

For each chemical factors:

skewness, outliers, long tail, multimodality -> transformations (log, sqrt)

对 predictor 做 transformation 的目的只有三类：

- 改善 predictor–response（quality）的线性关系
- 减少 right‐skew → 减轻 heteroscedasticity
- 改善 model interpretability（不影响科学解释）

这一步我们只看所有的numerical variable，通过只看x的分布histogram判断数据本身是否有skewness。如果有任何skewness的异常情况，我们在做具体分析时候对他们做transformation。
```{r}
# only numerical variables, excluding types
wine_numeric <- wine[, sapply(wine, is.numeric)]

wine_long <- pivot_longer(wine_numeric,
                          cols = everything(),
                          names_to = "variable",
                          values_to = "value")

ggplot(wine_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "white") +
  facet_wrap(~ variable, scales = "free") +
  theme_bw() +
  labs(title = "Histograms of Chemical Attributes")
```

### Conclusion

这是我们通过上述histogram看出来的结论，表格中写了需要transform的variable都显示了一定程度的异常。

| Variable              | Transformation |
|-----------------------|------------------------------|
| residual_sugar        | log(x + 0.1)                 |
| total_sulfur_dioxide  | log(x + 1)                   |
| free_sulfur_dioxide   | log(x + 1)                   |
| chlorides             | log(x)                       |
| volatile_acidity      | log(x)                       |
| sulphates             | log(x)                       |
| citric_acid           | log(x + 0.01)                |
| alcohol               | no transform                 |
| fixed_acidity         | no transform                 |
| density               | no transform (consider remove later) |
| pH                    | no transform                 |
| quality               | response, no transform       |



### Transformation

我们新建一个dataframe，将需要做transformation的变量全部transform，对于不需要transform的变量照常保留。

```{r}
wine_tf <- data.frame(
  # response
  quality = wine$quality,
  type = wine$type,
  
  # transformed predictors
  residual_sugar_t        = log(wine$residual_sugar + 0.1),
  total_sulfur_dioxide_t  = log(wine$total_sulfur_dioxide + 1),
  free_sulfur_dioxide_t   = log(wine$free_sulfur_dioxide + 1),
  chlorides_t             = log(wine$chlorides),
  volatile_acidity_t      = log(wine$volatile_acidity),
  sulphates_t             = log(wine$sulphates),
  citric_acid_t           = log(wine$citric_acid + 0.1),
  
  # raw predictors kept as-is
  alcohol          = wine$alcohol,
  fixed_acidity    = wine$fixed_acidity,
  pH               = wine$pH,
  density          = wine$density
)

```

现在再画个图检查，发现skewness解决很多了。

```{r}
wine_tf_numeric <- wine_tf[, sapply(wine_tf, is.numeric)]

wine_tf_long <- pivot_longer(wine_tf_numeric,
                          cols = everything(),
                          names_to = "variable",
                          values_to = "value")

ggplot(wine_tf_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "white") +
  facet_wrap(~ variable, scales = "free") +
  theme_bw()
```

## Boxplot by Type

`type`是我们唯一一个categorical（binary）变量。我们画所有numerical variable在红酒&白酒上的box plot分布，每个变量都对照查看红白酒的不同反应。我们这样做以检查红白酒本身是否和其他变量有interaction。

Diffrence in red and white wine according to each predictor -> look for potential interaction with type

```{r}
# Boxplot: chemical variable by type
wine_long2 <- pivot_longer(wine,
                           cols = -c(type, quality),
                           names_to = "variable",
                           values_to = "value")

ggplot(wine_long2, aes(x = type, y = value, fill = type)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_y") +
  theme_bw() +
  labs(title = "Boxplots of Chemical Attributes by Wine Type",
       x = "Wine Type", y = "Value")
```

### Conclusion

根据boxplot看到，红白酒对于同一变量差异特别大的话能说明有潜在的interaction：

- residual_sugar * type
- total_sulfur_dioxide * type
- free_sulfur_dioxide * type
- volatile_acidity * type
- fixed_acidity * type
- chlorides * type


## Correlation Heatmap

我们算numerical variable互相之间的correlation coefficient，也就是对于每个变量，都做一次它与其他所有变量的regression，并且计算每个beta coefficient的回归系数，这个热力图里面深红色深蓝色都需要注意观察，代表强正相关或者强负相关；少数中等深度的蓝色也要注意，代表潜在的interaction。

linear collinearity in between variables -> potential multicollinearity; strongest marginal relationships to quality

```{r}
corr_matrix <- cor(wine_numeric)   # numeric variables only
corrplot(corr_matrix, method = "color", tl.cex = 0.8)
```

### Conclusion
我们找出了可能的一些interaction，从强烈/适中/弱 三个层面来看。
我们在之后的candidate model design中，可以在每个模型中对于以下三种强度保留两者，但三种强度不要在同一模型中出现

strong:
- residual_sugar vs density
- free_sulfur_dioxide vs total_sulfur_dioxide
moderate:
- fixed_acidity vs citric_acid
- volatile_acidity vs citric_acid
- sulphates vs total_sulfur_dioxide
weak:
- alcohol vs anything
- pH vs anything


## Scatterplots: Quality vs Each Predictor

前面是单纯的看x的表现，现在看一下x和y之间的表现。我们画每个x单独和y的线性回归，看看分布和线条是否都正常。

```{r}
ggplot(wine_long2, aes(x = value, y = quality)) +
  geom_point(alpha = 0.15) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  facet_wrap(~ variable, scales = "free_x") +
  theme_bw() +
  labs(title = "Quality vs Chemical Attributes")
```


## Quality vs Predictor by Wine Type

和上面一样的图，只不过这时候把红白酒分开看，再次检验潜在的interaction。

investigate on slope difference of red and white wine -> as potential proof for type × variable interaction 

```{r}
# modified：只选择原始数据中的数值型化学变量，排除 quality 和 type
predictors <- wine %>%
  select(-quality, -type) %>%
  select(where(is.numeric)) %>%
  colnames()

# modified：仅对上述 predictors 做 pivot_longer，不使用 transformed data
wine_long <- wine %>%
  pivot_longer(
    cols = all_of(predictors),
    names_to = "variable",
    values_to = "value"
  )

ggplot(wine_long, aes(x = value, y = quality, color = type)) +
  geom_point(alpha = 0.15) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~ variable, scales = "free_x") +
  theme_bw(base_size = 14) +
  labs(
    title = "Quality vs Chemical Predictors by Wine Type",
    x = "Predictor Value",
    y = "Quality"
  )

```

### Conclusion

Strong:
- volatile_acidity * type
- chlorides * type
Moderate:
- total_sulfur_dioxide * type
- residual_sugar * type
Weak:
- citric_acid * type
- sulphates * type


## Quality Distribution by Type

单独看quality和红白酒的关系，我们会发现白酒的数量远多于红酒。分数分布也更高。
```{r}
ggplot(wine, aes(x = quality, fill = type)) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 20) +
  theme_bw() +
  labs(title = "Distribution of Wine Quality by Type")
```
