
```{r}
############################################################
## 0. 如果环境里已经有 mod_A1，可以跳过这一段
##    这里只是确保“均值结构”包含两个交互项
############################################################

mod_A1 <- lm(
  quality ~ fixed_acidity + volatile_acidity + citric_acid +
    residual_sugar + chlorides +
    free_sulfur_dioxide + total_sulfur_dioxide +
    density + pH + sulphates + alcohol +
    type +
    alcohol:type + volatile_acidity:type,
  data = wine
)
```
```{r}
############################################################
## 1. 用 A1 的残差构建 variance function
############################################################

# 1(a) 提取 A1 的普通残差
resid_A1 <- residuals(mod_A1)

# 1(b) 以 log(残差^2) 作为响应，拟合一个“方差模型”
# 这里选择直觉上可能影响方差的变量：alcohol, density, residual_sugar, type
var_mod <- lm(
  log(resid_A1^2) ~ alcohol + density + residual_sugar + type,
  data = wine
)

summary(var_mod)
```
```{r}
## 2. 根据方差模型计算每个观测的权重 w_i = 1 / Var_hat
############################################################

# 2(a) 方差模型给出的 log(Var_hat)
log_sigma2_hat <- fitted(var_mod)

# 2(b) 取指数还原成 Var_hat（因为刚才是 log）
sigma2_hat <- exp(log_sigma2_hat)

# 2(c) WLS 的权重 = 1 / Var_hat
w_hat <- 1 / sigma2_hat

# 可以简单看一下权重的分布（是否有极端值）
summary(w_hat)
```
```{r}
############################################################
## 3. 在相同均值结构下，用 w_hat 拟合 WLS（模型 B1）
############################################################

mod_B1 <- lm(
  quality ~ fixed_acidity + volatile_acidity + citric_acid +
    residual_sugar + chlorides +
    free_sulfur_dioxide + total_sulfur_dioxide +
    density + pH + sulphates + alcohol +
    type +
    alcohol:type + volatile_acidity:type,
  data = wine,
  weights = w_hat   # ★ 关键：把刚才构造的权重传进来
)

summary(mod_B1)

```
```{r}
############################################################
## 4. 比较 A1 (OLS) 和 B1 (WLS)
############################################################

# 4(a) 比较 AIC / BIC：越小越好
AIC(mod_A1, mod_B1)
BIC(mod_A1, mod_B1)

# 4(b) 比较调整后 R^2（作为参考）
summary(mod_A1)$adj.r.squared
summary(mod_B1)$adj.r.squared

```
```{r}
############################################################
## 5. 画 WLS 的诊断图，看异方差是否缓解
############################################################

# 5(a) Residuals vs Fitted
plot(mod_B1, which = 1)

# 5(b) Scale-Location（关键）
plot(mod_B1, which = 3)

# 5(c) Q-Q plot（正态性）
plot(mod_B1, which = 2)

# 5(d) Residuals vs Leverage（影响点）
plot(mod_B1, which = 5)

```