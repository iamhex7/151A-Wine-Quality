
```{r}
############################################################
## 预备：如果想名字和 slides 一致，也可以复制一份
############################################################

# 这一步只是把模型重命名为 mod_ols_full，方便和课件中的记号对应
mod_ols_full <- mod_full

```


```{r}
############################################################
## 1. 检查线性关系：Residuals vs Fitted
############################################################

# 这一步画出残差 vs 拟合值图（plot.lm 的第一个图）
# 主要看残差是否围绕 0 随机散布，是否有系统性的弯曲/模式
plot(mod_ols_full, which = 1)

```


```{r}
############################################################
## 1(b). Partial residual plots（如果课程允许用 car 包）
############################################################

# 这一步载入 car 包，用 crPlots() 画 partial residual plots
# 用来检查每个 predictor 与响应变量之间是否近似线性，
# 如果看到明显弯曲，说明可能需要加二次项 / 非线性变换 / interaction
library(car)

crPlots(mod_ols_full)

```


```{r}
############################################################
## 2(a). 用 Residuals vs Fitted / Scale-Location 图检查同方差
############################################################

# 这一步再看一次 Residuals vs Fitted（which = 1），
# 重点看是否出现“漏斗形”，即拟合值大时残差方差变大或变小
plot(mod_ols_full, which = 1)

# 这一步画 Scale-Location 图（也叫 Spread-Location），which = 3
# 纵轴是 sqrt(|standardized residuals|)，
# 若点大致水平分布则同方差较好；若呈上升/下降趋势则有异方差
plot(mod_ols_full, which = 3)

```


```{r}
############################################################
## 2(b). Breusch–Pagan Test（形式检验异方差）
############################################################

# 这一步载入 lmtest 包，用 bptest() 对模型做 Breusch-Pagan 异方差检验
# 原假设 H0：误差方差为常数（同方差）
# 若 p-value 很小（比如 < 0.05），拒绝 H0，说明存在显著异方差，
# 为我们后面考虑 heteroscedastic linear model / WLS 提供依据
library(lmtest)

bptest(mod_ols_full)

```


```{r}
############################################################
## 3(a). Normal Q-Q plot 检查残差是否接近正态
############################################################

# 这一步画 Normal Q-Q plot（which = 2），
# 用来比较残差分布与正态分布的差异。
# 如果点大致沿着对角线排列，说明正态性还可以；
# 尾部若有明显偏离，说明尾部比正态更重/更轻。
plot(mod_ols_full, which = 2)

```

```{r}
############################################################
## 3(b). 可选：画残差直方图，辅助观察分布形状
############################################################

# 这一步提取模型的残差，用 ggplot 画直方图，
# 进一步感受残差是否对称、是否有重尾
library(tidyverse)

augment_resid <- tibble(
  resid = residuals(mod_ols_full)
)

ggplot(augment_resid, aes(x = resid)) +
  geom_histogram(bins = 30, color = "black") +
  labs(
    title = "Histogram of residuals",
    x = "Residual",
    y = "Count"
  ) +
  theme_minimal()

```


```{r}
############################################################
## 4(a). Residuals vs Leverage 图 + Cook's distance
############################################################

# 这一步画 Residuals vs Leverage 图（which = 5），
# 图中会标出 Cook's distance 较大的点。
# 如果有个别点同时残差大、杠杆值大，并且 Cook's distance 接近或超过参考线，
# 说明这些点对回归结果有很强影响，需要在报告中讨论。
plot(mod_ols_full, which = 5)

############################################################
## 4(b). 数值上查看 Cook's distance 较大的观测
############################################################

# 这一步计算每个观测的 Cook's distance
cook_vals <- cooks.distance(mod_ols_full)

# 找出 Cook's distance 最大的若干个点（例如前 10 个）
# 方便我们在数据中定位这些 influential points
head(sort(cook_vals, decreasing = TRUE), 10)

```